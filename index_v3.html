<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OVERHAUL ‚Ä¢ Traffic Intelligence Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --primary: #00f5ff;
      --secondary: #ff00ff;
      --accent: #00ff88;
      --dark-1: #0a0a0f;
      --dark-2: #14141f;
      --dark-3: #1e1e2e;
      --dark-4: #28283d;
      --text-primary: #ffffff;
      --text-secondary: #a8a8b8;
      --border: rgba(0, 245, 255, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--dark-1);
      color: var(--text-primary);
      overflow-x: hidden;
      position: relative;
    }

    .code-font { font-family: 'Space Mono', monospace; }

    /* Animated Grid Background */
    .grid-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      background-image: 
        linear-gradient(rgba(0, 245, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 245, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: grid-flow 20s linear infinite;
    }

    @keyframes grid-flow {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    /* Floating Orbs */
    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.15;
      pointer-events: none;
      z-index: 1;
    }

    .orb-1 {
      width: 500px;
      height: 500px;
      background: var(--primary);
      top: -100px;
      right: -100px;
      animation: float-1 15s ease-in-out infinite;
    }

    .orb-2 {
      width: 400px;
      height: 400px;
      background: var(--secondary);
      bottom: -100px;
      left: -100px;
      animation: float-2 18s ease-in-out infinite;
    }

    .orb-3 {
      width: 350px;
      height: 350px;
      background: var(--accent);
      top: 50%;
      left: 50%;
      animation: float-3 12s ease-in-out infinite;
    }

    @keyframes float-1 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(-100px, 100px) scale(1.1); }
    }

    @keyframes float-2 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(100px, -100px) scale(1.15); }
    }

    @keyframes float-3 {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-60%, -40%) scale(1.2); }
    }

    /* Container */
    .container {
      position: relative;
      z-index: 10;
      min-height: 100vh;
      padding: 20px;
      max-width: 1920px;
      margin: 0 auto;
    }

    /* Navbar */
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 30px;
      background: rgba(20, 20, 31, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 20px;
      margin-bottom: 20px;
      position: sticky;
      top: 20px;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .logo-icon::before {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shine 3s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .logo-text h1 {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -1px;
    }

    .logo-text p {
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 5px;
      font-weight: 500;
    }

    /* Map Container */
    #map {
      width: 100%;
      height: 500px;
      border-radius: 15px;
      overflow: hidden;
      border: 2px solid rgba(0, 245, 255, 0.3);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: rgba(30, 30, 46, 0.8);
      border: 1px solid rgba(0, 245, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .stat-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary), var(--accent));
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateX(5px);
      border-color: rgba(0, 245, 255, 0.5);
    }

    .stat-card:hover::after {
      transform: scaleY(1);
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(0, 245, 255, 0.2), rgba(0, 255, 136, 0.2));
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      font-size: 20px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 5px;
      font-variant-numeric: tabular-nums;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .stat-source {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-delta {
      font-size: 13px;
      font-weight: 700;
      margin-top: 8px;
      padding: 4px 10px;
      border-radius: 8px;
      display: inline-block;
    }

    .stat-delta.positive {
      color: var(--accent);
      background: rgba(0, 255, 136, 0.1);
    }

    .stat-delta.negative {
      color: #ff4757;
      background: rgba(255, 71, 87, 0.1);
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 280px;
      margin-top: 20px;
    }

    /* Control Panel */
    .control-panel {
      position: sticky;
      top: 110px;
    }

    .input-group {
      margin-bottom: 25px;
    }

    .input-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .input-value {
      font-size: 16px;
      color: var(--primary);
      font-weight: 800;
      font-family: 'Space Mono', monospace;
    }

    textarea {
      width: 100%;
      background: rgba(30, 30, 46, 0.8);
      border: 1px solid rgba(0, 245, 255, 0.3);
      border-radius: 12px;
      padding: 15px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'Outfit', sans-serif;
      resize: vertical;
      min-height: 100px;
      transition: all 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 245, 255, 0.1);
    }

    textarea::placeholder {
      color: var(--text-secondary);
    }

    /* Custom Range Slider */
    input[type="range"] {
      appearance: none;
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--dark-3) 0%, var(--primary) 100%);
      outline: none;
      position: relative;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
      transition: all 0.2s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.3);
      box-shadow: 0 0 30px rgba(0, 245, 255, 0.8);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      cursor: pointer;
      border: none;
      box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
    }

    /* Mode Toggle */
    .mode-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 25px;
    }

    .mode-btn {
      padding: 15px;
      background: rgba(30, 30, 46, 0.8);
      border: 2px solid rgba(0, 245, 255, 0.2);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .mode-btn:hover {
      border-color: rgba(0, 245, 255, 0.5);
    }

    .mode-btn.active {
      background: linear-gradient(135deg, rgba(0, 245, 255, 0.2), rgba(0, 255, 136, 0.2));
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
    }

    /* Action Button */
    .btn-primary {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      border-radius: 12px;
      color: var(--dark-1);
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0, 245, 255, 0.3);
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn-primary:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(0, 245, 255, 0.5);
    }

    .btn-primary:active {
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary span {
      position: relative;
      z-index: 1;
    }

    /* Secondary Buttons */
    .btn-secondary {
      width: 100%;
      padding: 12px;
      background: rgba(30, 30, 46, 0.8);
      border: 1px solid rgba(0, 245, 255, 0.3);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-secondary:hover {
      background: rgba(0, 245, 255, 0.1);
      border-color: var(--primary);
    }

    .actions-grid {
      display: grid;
      gap: 10px;
      margin-top: 20px;
    }

    /* Summary Box */
    .summary-box {
      background: linear-gradient(135deg, rgba(0, 245, 255, 0.05), rgba(0, 255, 136, 0.05));
      border: 1px solid rgba(0, 245, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      position: relative;
      overflow: hidden;
    }

    .summary-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
      background-size: 200% 100%;
      animation: gradient-slide 3s linear infinite;
    }

    @keyframes gradient-slide {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    .summary-text {
      font-size: 15px;
      line-height: 1.8;
      color: var(--text-primary);
    }

    .live-sources {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 14px;
    }

    .live-chip {
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0, 245, 255, 0.4);
      background: rgba(0, 245, 255, 0.08);
      color: var(--primary);
    }

    .live-chip.muted {
      border-style: dashed;
      color: var(--text-secondary);
      background: transparent;
    }

    /* Recommendations List */
    .recommendations-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    .recommendation-item {
      background: rgba(30, 30, 46, 0.8);
      border: 1px solid rgba(0, 245, 255, 0.2);
      border-radius: 12px;
      padding: 18px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .recommendation-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, var(--primary), var(--accent));
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .recommendation-item:hover {
      border-color: rgba(0, 245, 255, 0.5);
      transform: translateX(8px);
    }

    .recommendation-item:hover::before {
      transform: scaleY(1);
    }

    .rec-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .rec-desc {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .rec-metrics {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .rec-metric {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .rec-metric-label {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .rec-metric-value {
      font-size: 14px;
      font-weight: 800;
      color: var(--accent);
      font-family: 'Space Mono', monospace;
    }

    /* Code Block */
    .code-block {
      background: rgba(10, 10, 15, 0.9);
      border: 1px solid rgba(0, 245, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
    }

    .code-block pre {
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      color: var(--primary);
      line-height: 1.6;
      margin: 0;
    }

    /* Loading Spinner */
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(0, 245, 255, 0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error Message */
    .error-message {
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid rgba(255, 71, 87, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-top: 15px;
      font-size: 13px;
      color: #ff4757;
      text-align: center;
      display: none;
    }

    .error-message.show {
      display: block;
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--dark-2);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--primary), var(--accent));
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, var(--accent), var(--secondary));
    }

    /* Fade In Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeInUp 0.6s ease forwards;
    }

    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.4; }
        100% { opacity: 1; }
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .navbar {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      #map {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="grid-bg"></div>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <div class="container">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="logo">
        <div class="logo-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
          </svg>
        </div>
        <div class="logo-text">
          <h1>OVERHAUL</h1>
          <p>Traffic Intelligence</p>
        </div>
      </div>
      <div class="nav-status">
        <div class="status-pill">
          <span class="status-dot"></span>
          <span id="systemStatus">System Online</span>
        </div>
        <div class="status-pill code-font" id="clockDisplay">00:00:00</div>
      </div>
    </nav>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Left Column -->
      <div>
        <!-- Map Card -->
        <div class="card fade-in delay-1">
          <div class="card-header">
            <div>
              <div class="card-title">Live Corridor Visualization</div>
              <div class="card-subtitle">Sector-78 ‚Üí Vasundhara ‚Ä¢ Delhi NCR Region</div>
            </div>
          </div>
          <div id="map"></div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid fade-in delay-2">
          <div class="stat-card">
            <div class="stat-icon">üïí</div>
            <div class="stat-value" id="statTravelTime">--</div>
            <div class="stat-label">Avg Travel Time</div>
            <div class="stat-source" id="sourceTravelTime"></div>
            <div class="stat-delta" id="deltaTravelTime"></div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚òÅÔ∏è</div>
            <div class="stat-value" id="statPM25">--</div>
            <div class="stat-label">PM‚ÇÇ.‚ÇÖ Level</div>
            <div class="stat-source" id="sourcePM25"></div>
            <div class="stat-delta" id="deltaPM25"></div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üöó</div>
            <div class="stat-value" id="statVKT">--</div>
            <div class="stat-label">Vehicle KM</div>
            <div class="stat-source" id="sourceVKT"></div>
            <div class="stat-delta" id="deltaVKT"></div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üî•</div>
            <div class="stat-value" id="statCO2">--</div>
            <div class="stat-label">CO‚ÇÇ Emissions</div>
            <div class="stat-source" id="sourceCO2"></div>
            <div class="stat-delta" id="deltaCO2"></div>
          </div>
        </div>

        <!-- Summary Card -->
        <div class="card fade-in delay-3">
          <div class="card-header">
            <div class="card-title">AI-Generated Analysis</div>
            <div id="confidenceBadge" class="glass-card px-3 py-1.5 rounded-full" style="font-size: 12px; font-weight: 600;">
              <span>Ready</span>
            </div>
          </div>
          <div class="summary-box">
            <div class="summary-text" id="summaryText">
              Configure your traffic scenario using the control panel. The system will analyze impacts on congestion, air quality, and emissions using advanced SUMO simulation and RAG-enhanced intelligence.
            </div>
            <div class="live-sources" id="liveSources"></div>
          </div>
        </div>

        <!-- Charts -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
          <div class="card fade-in delay-4">
            <div class="card-title">Travel Time Trends</div>
            <div class="chart-container">
              <canvas id="chartTravelTime"></canvas>
            </div>
          </div>
          <div class="card fade-in delay-4">
            <div class="card-title">Air Quality Index</div>
            <div class="chart-container">
              <canvas id="chartAQI"></canvas>
            </div>
          </div>
        </div>

        <!-- Recommendations -->
        <div class="card fade-in delay-4">
          <div class="card-header">
            <div>
              <div class="card-title">Recommended Interventions</div>
              <div class="card-subtitle">AI-ranked by predicted effectiveness</div>
            </div>
          </div>
          <div class="recommendations-list" id="recommendationsList">
            <div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
              Run analysis to view recommendations
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Control Panel -->
      <div class="control-panel">
        <div class="card fade-in delay-2">
          <div class="card-title">Control Panel</div>
          <div class="card-subtitle">Configure Traffic Scenario</div>

          <!-- Prompt -->
          <div class="input-group">
            <label class="input-label">Scenario Description</label>
            <textarea id="promptInput" placeholder="Describe your traffic scenario... e.g., 'Analyze 50% EV adoption impact on corridor congestion and air quality'"></textarea>
          </div>

          <!-- Mode Selection -->
          <div class="input-group">
            <label class="input-label">Analysis Mode</label>
            <div class="mode-toggle">
              <button class="mode-btn active" data-mode="fast">Fast</button>
              <button class="mode-btn" data-mode="deep">Deep</button>
            </div>
          </div>

          <!-- Run Button -->
          <button class="btn-primary" id="runButton">
            <span id="runButtonText">Run Analysis</span>
          </button>

          <div class="error-message" id="errorMessage"></div>

          <!-- Actions -->
          <div class="actions-grid">
            <button class="btn-secondary" id="exportButton">üì• Export Report</button>
            <button class="btn-secondary" id="copyButton">üìã Copy Manifest</button>
          </div>
        </div>

        <!-- Manifest Card -->
        <div class="card fade-in delay-3" style="margin-top: 20px;">
          <div class="card-header">
            <div class="card-title">Run Manifest</div>
            <div class="code-font" style="font-size: 11px; color: var(--text-secondary);" id="manifestId">--</div>
          </div>
          <div class="code-block">
            <pre id="manifestContent">Run analysis to generate manifest</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:8000'
      : 'https://overhaul-le1a.onrender.com';
    console.log('[OVERHAUL] Using API base', API_BASE);
    const DEFAULT_PROMPT = 'Analyze impact of increased EV adoption on corridor traffic flow and air quality';
    
    const state = {
      map: null,
      chartTravel: null,
      chartAQI: null,
      loading: false,
      mode: 'fast',
      manifest: null,
      liveContext: { sources: [] }
    };

    const els = {
      promptInput: document.getElementById('promptInput'),
      runButton: document.getElementById('runButton'),
      runButtonText: document.getElementById('runButtonText'),
      errorMessage: document.getElementById('errorMessage'),
      systemStatus: document.getElementById('systemStatus'),
      summaryText: document.getElementById('summaryText'),
      liveSources: document.getElementById('liveSources'),
      recommendationsList: document.getElementById('recommendationsList'),
      manifestContent: document.getElementById('manifestContent'),
      manifestId: document.getElementById('manifestId'),
      exportButton: document.getElementById('exportButton'),
      copyButton: document.getElementById('copyButton'),
      statTravelTime: document.getElementById('statTravelTime'),
      sourceTravelTime: document.getElementById('sourceTravelTime'),
      statPM25: document.getElementById('statPM25'),
      sourcePM25: document.getElementById('sourcePM25'),
      statVKT: document.getElementById('statVKT'),
      sourceVKT: document.getElementById('sourceVKT'),
      statCO2: document.getElementById('statCO2'),
      sourceCO2: document.getElementById('sourceCO2'),
      deltaTravelTime: document.getElementById('deltaTravelTime'),
      deltaPM25: document.getElementById('deltaPM25'),
      deltaVKT: document.getElementById('deltaVKT'),
      deltaCO2: document.getElementById('deltaCO2')
    };

    function mergeLiveContext(live) {
      if (!live) return state.liveContext;
      const currentSources = state.liveContext.sources || [];
      const incomingSources = (live.sources || []).map(src => ({
        name: src?.name || 'Live Feed',
        detail: src?.detail || ''
      }));

      const dedupedSources = [...currentSources];
      incomingSources.forEach(src => {
        const idx = dedupedSources.findIndex(existing => existing.name === src.name && existing.detail === src.detail);
        if (idx >= 0) {
          dedupedSources[idx] = { ...dedupedSources[idx], ...src };
        } else {
          dedupedSources.push(src);
        }
      });

      const mergedTravel = { ...(state.liveContext.travel || {}) };
      if (live.travel) Object.assign(mergedTravel, live.travel);
      const mergedAqi = { ...(state.liveContext.aqi || {}) };
      if (live.aqi) Object.assign(mergedAqi, live.aqi);

      state.liveContext = {
        ...state.liveContext,
        ...live,
        travel: Object.keys(mergedTravel).length ? mergedTravel : state.liveContext.travel,
        aqi: Object.keys(mergedAqi).length ? mergedAqi : state.liveContext.aqi,
        sources: dedupedSources
      };
      return state.liveContext;
    }

    // Clock
    function updateClock() {
      const now = new Date();
      const time = now.toTimeString().split(' ')[0];
      document.getElementById('clockDisplay').textContent = time;
    }
    updateClock();
    setInterval(updateClock, 1000);

    // Initialize Map
    function initMap() {
      state.map = new maplibregl.Map({
        container: 'map',
        style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
        center: [77.31, 28.60],
        zoom: 12.8,
        pitch: 50,
        bearing: -15
      });

      state.map.addControl(new maplibregl.NavigationControl(), 'top-right');

      state.map.on('load', () => {
        state.map.addSource('edges', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: [] }
        });

        state.map.addSource('pollution', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: [] }
        });

        state.map.addLayer({
          id: 'pollution-layer',
          type: 'circle',
          source: 'pollution',
          paint: {
            'circle-radius': [
              'interpolate',
              ['linear'],
              ['get', 'intensity'],
              0, 0,
              1, 40
            ],
            'circle-color': 'rgba(239,68,68,0.35)',
            'circle-stroke-color': 'rgba(248,113,113,0.8)',
            'circle-stroke-width': 1,
            'circle-opacity': 0.7
          }
        });
        state.map.addLayer({
          id: 'edges-layer',
          type: 'line',
          source: 'edges',
          paint: {
            'line-color': [
              'interpolate',
              ['linear'],
              ['get', 'ev_share'],
              0, '#475569',
              25, '#00f5ff',
              60, '#00ff88',
              90, '#ffff00'
            ],
            'line-width': ['case', ['get', 'primary'], 8, 4],
            'line-opacity': 0.9,
            'line-blur': 0.8
          }
        });
      });
    }
    function updateRouteLayer(geojson) {
      if (!state.map || !geojson) return;
      if (!state.map.getSource('route')) {
        state.map.addSource('route', { type: 'geojson', data: geojson });
        state.map.addLayer({
          id: 'route-layer',
          type: 'line',
          source: 'route',
          paint: {
            'line-color': '#7dd3fc',
            'line-width': 4,
            'line-opacity': 0.9
          }
        });
      } else {
        state.map.getSource('route').setData(geojson);
      }
    }
async function fetchLiveRoute() {
  if (!state.map) return;
  try {
    const resp = await fetch(`${API_BASE}/live/route`);
    if (!resp.ok) throw new Error('Route API failed');
    const geojson = await resp.json();
    updateRouteLayer(geojson);
    const sourceName = geojson?.features?.[0]?.properties?.source || 'Live Route Service';
    mergeLiveContext({
      travel: {
        ...(state.liveContext.travel || {}),
        geojson,
        source: sourceName
      },
      sources: [{ name: sourceName, detail: 'Corridor route overlay (live endpoint)' }]
    });
    renderLiveSources(state.liveContext);
  } catch (err) {
    console.error('Live route error', err);
    renderLiveSources(state.liveContext);
  }
}

async function fetchLiveAQI() {
  try {
    const resp = await fetch(`${API_BASE}/live/aqi?lat=28.62&lon=77.35`);
    if (!resp.ok) throw new Error('AQI API failed');
    const data = await resp.json();
    console.log('Live AQI series', data.series);
    const series = Array.isArray(data.series) ? data.series.filter(pt => pt.datetime && pt.pm25 != null) : [];
    const latest = series.length ? series[series.length - 1] : null;
    mergeLiveContext({
      aqi: {
        ...(state.liveContext.aqi || {}),
        series: series.slice(-48),
        latest_pm25: latest ? latest.pm25 : state.liveContext?.aqi?.latest_pm25,
        latest_timestamp: latest ? latest.datetime : state.liveContext?.aqi?.latest_timestamp
      },
      sources: [{ name: 'OpenAQ', detail: 'Direct corridor sensor bubble (live endpoint)' }]
    });
    renderLiveSources(state.liveContext);
  } catch (err) {
    console.error('Live AQI error', err);
    renderLiveSources(state.liveContext);
  }
}

    // Initialize Charts
    function initCharts() {
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(10, 10, 15, 0.9)',
            titleColor: '#00f5ff',
            bodyColor: '#ffffff',
            borderColor: '#00f5ff',
            borderWidth: 1
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(0, 245, 255, 0.1)' },
            ticks: { color: '#a8a8b8' }
          },
          y: {
            grid: { color: 'rgba(0, 245, 255, 0.1)' },
            ticks: { color: '#a8a8b8' }
          }
        }
      };

      state.chartTravel = new Chart(document.getElementById('chartTravelTime'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            data: [],
            borderColor: '#00f5ff',
            backgroundColor: 'rgba(0, 245, 255, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#00f5ff'
          }]
        },
        options: commonOptions
      });

      state.chartAQI = new Chart(document.getElementById('chartAQI'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            data: [],
            borderColor: '#ff00ff',
            backgroundColor: 'rgba(255, 0, 255, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#ff00ff'
          }]
        },
        options: commonOptions
      });
    }

    // Mode Selection
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.mode = btn.dataset.mode;
      });
    });

    // Build Scenario
    function buildScenario() {
      return {
        title: 'Prompt-driven analysis',
        region: 'Sector-78 to Vasundhara',
        intervention: 'prompt_only',
        horizon_months: 12,
        parameters: {}
      };
    }

    // Set Loading State
    function setLoading(loading) {
      state.loading = loading;
      els.runButton.disabled = loading;
      
      if (loading) {
        els.runButtonText.innerHTML = '<div class="spinner"></div>';
        els.systemStatus.textContent = state.mode === 'deep' ? 'Deep Analysis Running' : 'Fast Analysis Running';
      } else {
        els.runButtonText.textContent = 'Run Analysis';
        els.systemStatus.textContent = 'System Online';
      }
    }

    // Show Error
    function showError(message) {
      els.errorMessage.textContent = message;
      els.errorMessage.classList.add('show');
      setTimeout(() => els.errorMessage.classList.remove('show'), 5000);
    }

    // Update Stats
    function updateStats(baseline, outputs, live) {
      if (!baseline) return;

      const sourceLabel = (isLive, provider) => isLive ? `Live ‚Ä¢ ${provider}` : 'Scenario Model';

      const setDelta = (el, value) => {
        if (value === undefined || value === null) {
          el.textContent = '';
          el.className = 'stat-delta';
          return;
        }
        const num = parseFloat(value);
        if (num < 0) {
          el.className = 'stat-delta positive';
          el.textContent = `${num.toFixed(1)}%`;
        } else if (num > 0) {
          el.className = 'stat-delta negative';
          el.textContent = `+${num.toFixed(1)}%`;
        } else {
          el.className = 'stat-delta';
          el.textContent = '0%';
        }
      };

      // Extract delta from impact cards
      const getDelta = (theme) => {
        if (!outputs || !outputs.impactCards) return null;
        const card = outputs.impactCards.find(c => c.theme && c.theme.toLowerCase().includes(theme));
        if (card && card.delta) {
          const match = card.delta.match(/([-+]?\d+\.?\d*)/);
          return match ? parseFloat(match[1]) : null;
        }
        return null;
      };

      const travelVal = live?.travel?.travel_time_min ?? baseline.avg_travel_time_min;
      els.statTravelTime.textContent = travelVal ? travelVal.toFixed(1) + ' min' : '--';
      els.sourceTravelTime.textContent = sourceLabel(!!live?.travel, live?.travel?.source || 'OSRM');
      setDelta(els.deltaTravelTime, getDelta('travel'));

      const pmVal = live?.aqi?.latest_pm25 ?? baseline.pm25;
      els.statPM25.textContent = pmVal ? pmVal.toFixed(1) + ' ¬µg/m¬≥' : '--';
      els.sourcePM25.textContent = sourceLabel(!!live?.aqi, 'OpenAQ');
      setDelta(els.deltaPM25, getDelta('air'));

      els.statVKT.textContent = baseline.total_vkt ? Math.round(baseline.total_vkt) + ' km' : '--';
      els.sourceVKT.textContent = 'Scenario Model';
      setDelta(els.deltaVKT, getDelta('vkt'));

      els.statCO2.textContent = baseline.co2_kg ? Math.round(baseline.co2_kg) + ' kg' : '--';
      els.sourceCO2.textContent = 'Scenario Model';
      setDelta(els.deltaCO2, getDelta('co2'));
    }

    // Update Charts
    function updateCharts(baseline, candidate, live) {
      if (!baseline) return;

      // Generate time series data (simulated progression)
      const hours = ['0h', '2h', '4h', '6h', '8h', '10h', '12h'];
      const baselineTravel = (live?.travel?.travel_time_min ?? baseline.avg_travel_time_min) || 0;
      const candidateTravel = candidate?.avg_travel_time_min || baselineTravel;
      
      // Simulate improvement progression
      const travelData = hours.map((_, i) => {
        const progress = i / (hours.length - 1);
        return baselineTravel - (baselineTravel - candidateTravel) * progress;
      });

      let aqiLabels = hours;
      let aqiData = [];
      if (live?.aqi?.series?.length) {
        aqiLabels = live.aqi.series.map(pt => {
          const date = new Date(pt.datetime);
          return `${date.getHours()}:00`;
        });
        aqiData = live.aqi.series.map(pt => pt.pm25);
      } else {
        const baselinePM = baseline.pm25 || 0;
        const candidatePM = candidate?.pm25 || baselinePM;
        aqiData = hours.map((_, i) => {
          const progress = i / (hours.length - 1);
          return baselinePM - (baselinePM - candidatePM) * progress;
        });
      }

      state.chartTravel.data.labels = hours;
      state.chartTravel.data.datasets[0].data = travelData;
      state.chartTravel.update('none');

      state.chartAQI.data.labels = aqiLabels;
      state.chartAQI.data.datasets[0].data = aqiData;
      state.chartAQI.update('none');
    }

    // Update Map
    function updateMap(geojson,pollution) {
      if (!state.map || !geojson) return;
      const source = state.map.getSource('edges');
      if (source) {
        // Ensure geojson has proper structure
        const validGeojson = geojson.type === 'FeatureCollection' ? geojson : {
          type: 'FeatureCollection',
          features: Array.isArray(geojson) ? geojson : []
        };
        source.setData(validGeojson);
        
        // Fit bounds to show all features
        if (validGeojson.features && validGeojson.features.length > 0) {
          const bounds = validGeojson.features.reduce((bounds, feature) => {
            if (feature.geometry && feature.geometry.coordinates) {
              feature.geometry.coordinates.forEach(coord => {
                bounds.extend(coord);
              });
            }
            return bounds;
          }, new maplibregl.LngLatBounds());
          
          if (!bounds.isEmpty()) {
            state.map.fitBounds(bounds, { padding: 50, maxZoom: 14 });
          }
        }
      }
      const pollutionSource = state.map.getSource('pollution');
      if (pollutionSource && pollution) {
        const validPollution = pollution.type === 'FeatureCollection' ? pollution : {
          type: 'FeatureCollection',
          features: Array.isArray(pollution) ? pollution : []
        };
        pollutionSource.setData(validPollution);
      }
    }

    // Render Recommendations
    function renderRecommendations(items) {
      if (!items || !items.length) {
        els.recommendationsList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">No recommendations available</div>';
        return;
      }

      els.recommendationsList.innerHTML = items.slice(0, 5).map((item, i) => {
        const timeSaved = item.pred_delta_tt_min || 0;
        const impact = timeSaved > 0 ? 'High' : timeSaved > -1 ? 'Medium' : 'Low';
        const cost = item.cost || (timeSaved > 5 ? 'High' : timeSaved > 2 ? 'Medium' : 'Low');
        
        return `
          <div class="recommendation-item fade-in" style="animation-delay: ${i * 0.1}s;">
            <div class="rec-title">${item.name || 'Intervention ' + (i + 1)}</div>
            <div class="rec-desc">${item.desc || 'Strategic intervention to optimize traffic flow'}</div>
            <div class="rec-metrics">
              <div class="rec-metric">
                <div class="rec-metric-label">Time Saved</div>
                <div class="rec-metric-value">${timeSaved > 0 ? '-' : ''}${Math.abs(timeSaved).toFixed(1)} min</div>
              </div>
              <div class="rec-metric">
                <div class="rec-metric-label">Impact</div>
                <div class="rec-metric-value">${impact}</div>
              </div>
              <div class="rec-metric">
                <div class="rec-metric-label">Cost</div>
                <div class="rec-metric-value">${cost}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderLiveSources(live = state.liveContext) {
      if (!els.liveSources) return;
      const sources = live?.sources || [];
      if (!sources.length) {
        els.liveSources.innerHTML = '<span class="live-chip muted">Awaiting live data...</span>';
        return;
      }
      const chips = sources.map(src => {
        const title = src.detail ? ` title="${src.detail}"` : '';
        return `<span class="live-chip"${title}>${src.name}</span>`;
      });
      els.liveSources.innerHTML = chips.join('');
    }

    // Run Analysis
    async function runAnalysis() {
      if (state.loading) return;

      const prompt = els.promptInput.value.trim() || DEFAULT_PROMPT;
      const scenario = buildScenario();

      setLoading(true);
      els.errorMessage.classList.remove('show');

      try {
        const response = await fetch(`${API_BASE}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, mode: state.mode, scenario })
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || 'Analysis failed');
        }

        const data = await response.json();
        console.log('Backend response:', data);

        mergeLiveContext(data.live || {});
        renderLiveSources(state.liveContext);

        const tldr = data.outputs?.tldr || data.summary || 'Analysis completed successfully';
        const narrative = Array.isArray(data.outputs?.narrative) ? data.outputs.narrative : [];
        const explanation = Array.isArray(data.outputs?.explanation) ? data.outputs.explanation : [];
        const deepFacts = Array.isArray(data.outputs?.deepFacts) ? data.outputs.deepFacts : [];
        const dialogue = Array.isArray(data.outputs?.multiAgentDigest) ? data.outputs.multiAgentDigest : [];
        const logs = Array.isArray(data.outputs?.logs) ? data.outputs.logs : [];

        let html = '';
        
        if (logs.length) {
             html += '<div style="background: rgba(0,20,40,0.8); border: 1px solid var(--neon-cyan); border-radius: 8px; padding: 15px; margin-bottom: 20px; font-family: \'Space Mono\', monospace; font-size: 0.85em; color: var(--text-secondary); box-shadow: 0 0 15px rgba(0,255,255,0.1);">';
             html += '<div style="margin-bottom:8px; font-weight:bold; color:var(--neon-cyan); display:flex; align-items:center; gap:8px;"><span style="animation: pulse 2s infinite;">‚óè</span> SYSTEM TRACE</div>';
             html += logs.map((l, i) => `<div style="margin-bottom:4px; opacity:0; animation: fadeIn 0.3s forwards; animation-delay: ${i * 0.1}s;">> ${l}</div>`).join('');
             html += '</div>';
        }

        html += `<p style="margin-bottom:12px;"><strong>Executive summary:</strong> ${tldr}</p>`;

        if (narrative.length) {
          html += '<p style="margin:10px 0 4px;"><strong>Key storylines:</strong></p><ul style="margin-left:18px;">' +
            narrative.map(line => `<li>${line}</li>`).join('') +
            '</ul>';
        }

        if (explanation.length) {
          html += '<p style="margin:10px 0 4px;"><strong>Interventions:</strong></p><ol style="margin-left:18px;">' +
            explanation.map(step => `<li><strong>${step.title}:</strong> ${step.detail}</li>`).join('') +
            '</ol>';
        }

        if (deepFacts.length) {
          html += '<p style="margin:10px 0 4px;"><strong>Historical context:</strong></p><ul style="margin-left:18px;">' +
            deepFacts.map(f => `<li>${f.detail}</li>`).join('') +
            '</ul>';
        }

        if (dialogue.length) {
          html += '<p style="margin:10px 0 4px;"><strong>Agent chain:</strong></p><ul style="margin-left:18px;">' +
            dialogue.map(line => `<li>${line}</li>`).join('') +
            '</ul>';
        }

        els.summaryText.innerHTML = html;

        updateStats(data.baseline, data.outputs, data.live);

        const candidateData = data.ranked && data.ranked[0] ? data.ranked[0] : null;
        updateCharts(data.baseline, candidateData, data.live);

        renderRecommendations(data.ranked);

        updateMap(data.edges_geojson, data.pollution_hotspots);
        if (data.live?.travel?.geojson) {
          updateRouteLayer(data.live.travel.geojson);
        }

        if (data.manifest) {
          state.manifest = data.manifest;
          els.manifestContent.textContent = JSON.stringify(data.manifest, null, 2);
          els.manifestId.textContent = data.manifest.run_id || '--';
        }

        if (data.outputs?.confidenceLevel) {
          const level = data.outputs.confidenceLevel;
          const badge = document.querySelector('#confidenceBadge');
          if (badge) {
            badge.textContent = level.charAt(0).toUpperCase() + level.slice(1) + ' Confidence';
            badge.className = `glass-card px-3 py-1.5 rounded-full ${
              level === 'high' ? 'bg-emerald-500/20 border-emerald-500/40 text-emerald-300' :
              level === 'medium' ? 'bg-amber-500/20 border-amber-500/40 text-amber-300' :
              'bg-rose-500/20 border-rose-500/40 text-rose-300'
            }`;
          }
        }

      } catch (error) {
        console.error('Analysis error:', error);
        showError(error.message || 'Failed to connect to backend. Ensure FastAPI is running on port 8000.');
        renderLiveSources(state.liveContext);
      } finally {
        setLoading(false);
      }
    }

    // Export Report
    function exportReport() {
      if (!state.manifest) {
        showError('No data to export. Run analysis first.');
        return;
      }

      const report = {
        timestamp: new Date().toISOString(),
        summary: els.summaryText.textContent,
        scenario: buildScenario(),
        manifest: state.manifest
      };

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `overhaul-report-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Copy Manifest
    async function copyManifest() {
      if (!state.manifest) {
        showError('No manifest to copy. Run analysis first.');
        return;
      }

      try {
        await navigator.clipboard.writeText(JSON.stringify(state.manifest, null, 2));
        const originalText = els.copyButton.textContent;
        els.copyButton.textContent = '‚úì Copied!';
        setTimeout(() => els.copyButton.textContent = originalText, 2000);
      } catch (error) {
        showError('Failed to copy to clipboard');
      }
    }

    renderLiveSources();

    // Event Listeners
    els.runButton.addEventListener('click', runAnalysis);
    els.exportButton.addEventListener('click', exportReport);
    els.copyButton.addEventListener('click', copyManifest);

    // Keyboard Shortcut
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runAnalysis();
      }
    });

    // Initialize
    els.promptInput.value = DEFAULT_PROMPT;
    initMap();
    initCharts();
    fetchLiveRoute();
    fetchLiveAQI();
  </script>
</body>
</html>
